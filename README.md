# go-hnswlib

Go bindings for [hnswlib](https://github.com/nmslib/hnswlib) using c-for-go.

## Quick Start

**One command to build everything:**

```bash
./build.sh
```

This script will:
1. ğŸ“¦ Initialize and update the hnswlib git submodule
2. ğŸ” Check for required tools (Go, C++, c-for-go)
3. ğŸ“¥ Install c-for-go if needed
4. ğŸ”¨ Build the C++ wrapper static library
5. ğŸ¯ Generate Go bindings using c-for-go
6. ğŸ”§ Build and test the Go module
7. âœ… Verify everything works
8. ğŸ§¹ Clean up intermediate build artifacts

## Overview

This project provides Go bindings for the hnswlib C++ library through a thin C wrapper. The wrapper allows you to use HNSW (Hierarchical Navigable Small World) approximate nearest neighbor search from Go.

## Project Structure

```
go-hnswlib/
â”œâ”€â”€ .gitmodules           # Git submodule configuration
â”œâ”€â”€ build.sh             # One-command build script
â”œâ”€â”€ hnswlib/             # Git submodule: original hnswlib C++ library
â”œâ”€â”€ hnsw_wrapper.h       # C wrapper header
â”œâ”€â”€ hnsw_wrapper.cpp     # C wrapper implementation  
â”œâ”€â”€ Makefile            # Builds static library
â”œâ”€â”€ cforgo.yml          # c-for-go configuration
â”œâ”€â”€ bindings/           # Generated Go bindings
â”‚   â”œâ”€â”€ gen.go         # go:generate directives
â”‚   â””â”€â”€ bindings/      # Generated by c-for-go (auto-created)
â”œâ”€â”€ hnsw/              # High-level Go wrapper
â”‚   â””â”€â”€ index.go      # Ergonomic Go API
â””â”€â”€ example/           # Usage example
    â””â”€â”€ main.go
```

## Prerequisites

- **Go 1.18+**
- **C++11 compatible compiler** (clang++ or g++)
- **Git** (for submodules)

The build script will automatically install `c-for-go` if needed.

## Building

### Simple Build (Recommended)
```bash
git clone <your-repo>
cd go-hnswlib
./build.sh
```

### Manual Build
```bash
# Initialize submodules
git submodule update --init --recursive

# Install c-for-go
go install github.com/xlab/c-for-go@latest

# Build everything
make clean
go generate ./...
go build ./...

# Optional: Clean up intermediate files
make clean-objects
```

## Usage

```go
package main

import (
    "fmt"
    "github.com/vikimaster2/go-hnswlib/hnsw"
)

func main() {
    // Create index: L2 space, 128 dimensions, max 1000 elements
    index := hnsw.NewL2(128, 1000, 16, 200, 42)
    defer index.Close()

    // Add vectors
    vec := make([]float32, 128)
    // ... populate vec ...
    index.Add(vec, 0) // label = 0

    // Search for 5 nearest neighbors
    query := make([]float32, 128)
    // ... populate query ...
    labels, distances, count := index.SearchK(query, 5)
    
    fmt.Printf("Found %d neighbors\n", count)
    for i := 0; i < count; i++ {
        fmt.Printf("Label: %d, Distance: %f\n", labels[i], distances[i])
    }
}
```

### Run Example
```bash
go run example/main.go
```

## API

### Index Creation
- `hnsw.NewL2(dim, maxElements, M, efConstruction, seed)` - L2 (Euclidean) space
- `hnsw.NewIP(dim, maxElements, M, efConstruction, seed)` - Inner product space  
- `hnsw.Load(space, dim, path)` - Load from file

### Index Operations
- `index.Add(vec, label)` - Add vector with label
- `index.SearchK(query, k)` - Search k nearest neighbors
- `index.SetEf(ef)` - Set search parameter
- `index.Save(path)` - Save to file
- `index.Close()` - Free memory

## Parameters

- `dim` - Vector dimension
- `maxElements` - Maximum number of elements
- `M` - Number of bi-directional links for each node (typically 16)
- `efConstruction` - Size of dynamic candidate list (typically 200)
- `ef` - Search parameter, controls accuracy vs speed tradeoff
- `seed` - Random seed

## Updating hnswlib

The hnswlib library is included as a git submodule. To update to the latest version:

```bash
git submodule update --remote hnswlib
./build.sh  # Rebuild everything
```

Or update to a specific version:
```bash
cd hnswlib
git checkout v0.8.0  # or any tag/commit
cd ..
./build.sh
```

## Cleaning Options

The build system provides several cleaning options:

```bash
make clean-objects   # Remove only .o files (keep static library)
make clean          # Remove all build/ directory 
make clean-all      # Remove build/ and bindings/bindings/
```

**Note**: The `./build.sh` script automatically cleans up intermediate object files after a successful build, keeping only the static library and generated bindings needed for Go compilation.

## Development

### Project Philosophy
- **Keep hnswlib untouched**: The `hnswlib/` directory is a git submodule and should never be modified
- **Thin C wrapper**: Minimal C ABI that exposes essential hnswlib functionality
- **Generated bindings**: Use c-for-go to automatically generate Go bindings
- **Ergonomic Go API**: High-level wrapper that feels natural to Go developers
- **One-command build**: Everything should build from scratch with `./build.sh`

### Build Process Flow
1. Git submodule ensures specific hnswlib version
2. C++ wrapper (`hnsw_wrapper.cpp`) provides C ABI
3. Makefile builds static library (`libhnsw_wrapper.a`)
4. c-for-go generates Go bindings from C header
5. High-level Go wrapper provides ergonomic API

### Regenerating Bindings
```bash
make clean
rm -rf bindings/bindings
go generate ./...
```

## Troubleshooting

### Build Issues
- **"c-for-go not found"**: The build script will install it automatically, ensure `$GOPATH/bin` is in your `$PATH`
- **"No C++ compiler"**: Install clang++ or g++
- **"hnswlib submodule not found"**: Run `git submodule update --init --recursive`

### Runtime Issues  
- **"library not found"**: Make sure you built with `./build.sh` or `go generate ./...`
- **Segmentation fault**: Ensure you're calling `defer index.Close()` and not using the index after closing

## License

This wrapper is provided under the same license as the original hnswlib library.